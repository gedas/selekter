const SELECTION_EVENT="selection";class Selection{constructor(e){this.elements=new Set(e)}get size(){return this.elements.size}values(){return this.elements.values()}add(e){let t=this.elements.has(e);return this.elements.add(e),t||this.notify(e,!0),this}delete(e){return this.elements.delete(e)&&!this.notify(e,!1)}has(e){return this.elements.has(e)}clear(){this.elements.forEach(e=>this.delete(e))}toggle(e,t){return void 0===t?!this.delete(e)&&!!this.add(e):(t?this.add(e):this.delete(e),t)}intersect(e){this.elements.forEach(t=>!e.has(t)&&this.delete(t))}notify(e,t){e.dispatchEvent(new CustomEvent("selection",{bubbles:!0,detail:{selected:t}}))}}const matches=Element.prototype.matches||Element.prototype.msMatchesSelector,defaults$1={tick:".selekter-tick"};class MouseSelector{constructor(e){this.options=e,this.onClick=(e=>{let t=e.target.closest(this.area.options.selectable);if(t){let s=this.area.getSelection();(s.size>0||matches.call(e.target,this.options.tick))&&s.toggle(t)}}),this.options=Object.assign({},defaults$1,e)}connect(e){return this.area=e,this.area.root.addEventListener("click",this.onClick),()=>this.area.root.removeEventListener("click",this.onClick)}}class Rect{constructor(e=0,t=0,s=0,i=0){this.left=e,this.top=t,this.width=s,this.height=i}static from(e){return new Rect(e.left,e.top,e.width,e.height)}intersects(e){return this.left<=e.left+e.width&&e.left<=this.left+this.width&&this.top<=e.top+e.height&&e.top<=this.top+this.height}}const defaults$2={lassoClass:"selekter-lasso",threshold:10,boundary:e=>e.getBoundingClientRect(),appendTo:document.body};class RectSelector extends Rect{constructor(e){super(),this.options=e,this.onMouseDown=(e=>{0!==e.button||e.target!==document.documentElement&&e.target!==this.area.root||(this.origin=this.getPageCoordinates(e),this.preservedSelection=e.ctrlKey||e.metaKey?new Set(this.area.getSelection().values()):null,document.addEventListener("mousemove",this.onMouseMove),document.addEventListener("mouseup",this.onMouseUp),e.preventDefault())}),this.onMouseMove=(e=>{e.preventDefault();let t=this.getPageCoordinates(e);this.top=Math.min(this.origin.top,t.top),this.left=Math.min(this.origin.left,t.left),this.width=Math.abs(this.origin.left-t.left),this.height=Math.abs(this.origin.top-t.top),this.setVisible(this.lasso,this.doesEdgePassThreshold())&&(this.lasso||(this.lasso=this.options.appendTo.appendChild(this.createLassoElement())),this.requestRender()),this.update()}),this.onMouseUp=(()=>{this.cancelRender(),this.update(),this.width=this.height=0,this.setVisible(this.lasso,!1),document.removeEventListener("mousemove",this.onMouseMove),document.removeEventListener("mouseup",this.onMouseUp)}),this.update=(()=>{let e=this.area.getSelection();this.area.getSelectables().forEach(t=>{e.toggle(t,this.preservedSelection&&this.preservedSelection.has(t)||this.doesEdgePassThreshold()&&this.intersects(this.translateByScroll(Rect.from(this.options.boundary(t)))))})}),this.render=(()=>{let e=this.lasso.style;e.left=this.left+"px",e.top=this.top+"px",e.width=this.width+"px",e.height=this.height+"px",this.pendingRenderID=0}),this.options=Object.assign({},defaults$2,e)}connect(e){return this.area=e,document.addEventListener("mousedown",this.onMouseDown),()=>document.removeEventListener("mousedown",this.onMouseDown)}requestRender(){this.pendingRenderID||(this.pendingRenderID=requestAnimationFrame(this.render))}cancelRender(){this.pendingRenderID&&(cancelAnimationFrame(this.pendingRenderID),this.pendingRenderID=0)}setVisible(e,t){return e&&(e.style.display=t?"":"none"),t}doesEdgePassThreshold(){return this.width>=this.options.threshold||this.height>=this.options.threshold}translateByScroll(e){let t=document.body,s=document.documentElement;return e.left+=t.scrollLeft||s.scrollLeft,e.top+=t.scrollTop||s.scrollTop,e}getPageCoordinates(e){return this.translateByScroll({left:e.clientX,top:e.clientY})}createLassoElement(){let e=document.createElement("div");return e.classList.add(this.options.lassoClass),e}}const defaultSelectors=[new MouseSelector,new RectSelector],defaults={selectable:".selekter-selectable",selectionClass:"selekter-selection",selectedClass:"selekter-selected"};class Area{constructor(e,t,s=defaultSelectors){this.root=e,this.options=t,this.selection=new Selection,this.rootDirty=!0,this.onSelection=(e=>{this.root.classList.toggle(this.options.selectionClass,this.selection.size>0),e.target.classList.toggle(this.options.selectedClass,e.detail.selected)}),this.options=Object.assign({},defaults,t),this.observer=this.observeDescendants(e,()=>this.rootDirty=!0),this.selectorDisconnectors=this.lastUniqueByConstructor(s).map(e=>e.connect(this)),e.addEventListener("selection",this.onSelection)}getSelection(){return this.rootDirty&&(this.selection.intersect(this.getSelectables()),this.rootDirty=!1),this.selection}getSelectables(){return this.rootDirty&&(this.selectables=new Set([...this.root.querySelectorAll(this.options.selectable)]),this.rootDirty=!1),this.selectables}destroy(){this.observer.disconnect(),this.selectorDisconnectors.forEach(e=>e()),this.root.removeEventListener("selection",this.onSelection)}observeDescendants(e,t){let s=new MutationObserver(t);return s.observe(e,{childList:!0,subtree:!0}),s}lastUniqueByConstructor(e){return e.reduceRight((e,t)=>(!e.some(e=>e.constructor===t.constructor)&&e.push(t),e),[])}}export{defaultSelectors,Area,MouseSelector,Rect,RectSelector,SELECTION_EVENT,Selection};
